<style>
    /* Các style tùy chỉnh cho diễn đàn */
    .filter-nav .nav-link { color: #6c757d; border-bottom: 3px solid transparent; padding-bottom: 0.5rem; transition: all 0.2s ease-in-out; }
    .filter-nav .nav-link.active, .filter-nav .nav-link:hover { color: #0d6efd; border-bottom-color: #0d6efd; font-weight: 500; }

    .category-nav .nav-link { color: #212529; font-weight: 500; }
    .category-nav .nav-link.active { color: #0d6efd; }
    
    .post-item { transition: background-color 0.2s ease-in-out; }
    .post-item:hover { background-color: #f8f9fa; }
    
    /* [SỬA] Tăng kích thước thanh tìm kiếm và thay đổi giao diện */
    .search-form-custom {
        border-radius: 0.5rem; /* Bo tròn hơn */
        border: 1px solid #dee2e6;
        padding: 0.25rem; /* Giảm padding ngoài */
        background-color: #fff;
        display: flex;
        width: 100%;
        max-width: 350px; /* Giới hạn chiều rộng tối đa */
    }
    .search-form-custom .form-control {
        padding-top: 0.75rem; /* Tăng padding trong để thanh to hơn */
        padding-bottom: 0.75rem;
    }

    .sticky-post {
      background-color: #fffbe6;
      border-left: 4px solid #ffc107;
      padding-left: 20px;
    }
    .post-meta-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1rem;
        color: #6c757d;
        font-size: 0.875rem;
    }
    .post-meta-item .far {
        margin-right: 0.35rem;
    }
    .topic-title {
        font-size: 1.1rem;
        font-weight: 500;
    }
    .topic-details {
        font-size: 0.85rem;
    }
</style>

<!-- [SỬA] Thêm my-5 để tạo khoảng cách với header -->
<div class="container-fluid px-lg-5 my-5"> 
    <div class="row">
        <!-- Cột Nội Dung Chính -->
        <div class="col-lg-9">
            <!-- Header -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <div>
                    <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                    <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
                </div>
            </div>

            <!-- Bố cục bộ lọc và tìm kiếm MỚI -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center border-bottom pb-3 mb-3 category-nav">
                        <strong class="me-3">Danh mục:</strong>
                        <ul class="nav nav-pills">
                            <li class="nav-item"><a class="nav-link <%= (!filters || !filters.category || filters.category === 'all') ? 'active' : '' %>" href="?sort=<%= (filters && filters.sort) ? filters.sort : 'latest' %>&category=all">Tất cả bài đăng</a></li>
                            <% if (locals.categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { if (cat && cat._id) { %>
                                    <li class="nav-item"><a class="nav-link <%= (filters && filters.category === cat._id) ? 'active' : '' %>" href="?sort=<%= (filters && filters.sort) ? filters.sort : 'latest' %>&category=<%= cat._id %>"><%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %></a></li>
                                <% }}); %>
                            <% } %>
                        </ul>
                    </div>
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <ul class="nav nav-pills filter-nav mb-3 mb-md-0">
                            <li class="nav-item"><a class="nav-link <%= (!filters || !filters.sort || filters.sort === 'latest') ? 'active' : '' %>" href="?sort=latest&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Mới nhất</a></li>
                            <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'popular') ? 'active' : '' %>" href="?sort=popular&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Nổi bật</a></li>
                            <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'discussed') ? 'active' : '' %>" href="?sort=discussed&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Thảo luận nhiều</a></li>
                        </ul>
                        <form action="/forum" method="GET" class="d-flex search-form-custom">
                            <input type="hidden" name="sort" value="<%= (filters && filters.sort) ? filters.sort : 'latest' %>">
                            <input type="hidden" name="category" value="<%= (filters && filters.category) ? filters.category : 'all' %>">
                            <input type="text" name="q" class="form-control border-0 shadow-none" placeholder="Tìm kiếm chủ đề..." value="<%= (filters && filters.q) ? filters.q : '' %>">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <% if (typeof error !== 'undefined' && error) { %><div class="alert alert-danger"><%= error %></div><% } %>
            
            <!-- Phần hiển thị bài đăng (đã được gộp vào đây) -->
            <div class="list-group">
                 <% if (posts && posts.length > 0) { %>
                    <%# --- CODE HIỂN THỊ DỮ LIỆU THẬT --- %>
                <% } else { %>
                    <%# --- CODE HIỂN THỊ BÀI ĐĂNG MẪU --- %>
                <% } %>
            </div>
            
            <!-- Pagination -->
            <% if (posts && posts.length > 0 && totalPages > 1) { %>
                <%- include('../../partials/pagination', { currentPage: currentPage, totalPages: totalPages, baseUrl: `/forum?sort=${(filters && filters.sort) ? filters.sort : 'latest'}&category=${(filters && filters.category) ? filters.category : 'all'}&q=${(filters && filters.q) ? filters.q : ''}` }) %>
            <% } %>
        </div>

        <!-- Thanh Bên Phải -->
        <div class="col-lg-3">
            <%- include('../../partials/_forumSidebar', { totalPosts: totalPosts || 0, user: user || null }) %>
        </div>
    </div>
</div>

