<style>
    /* Các style tùy chỉnh cho diễn đàn */
    .filter-nav .nav-link { color: #6c757d; border-bottom: 3px solid transparent; padding-bottom: 0.5rem; transition: all 0.2s ease-in-out; }
    .filter-nav .nav-link.active, .filter-nav .nav-link:hover { color: #0d6efd; border-bottom-color: #0d6efd; font-weight: 500; }

    .category-nav .nav-link { color: #212529; font-weight: 500; }
    .category-nav .nav-link.active { color: #0d6efd; }
    
    .post-item { transition: background-color 0.2s ease-in-out; }
    .post-item:hover { background-color: #f8f9fa; }
    
    /* [SỬA] Tăng kích thước thanh tìm kiếm và thay đổi giao diện */
    .search-form-custom {
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
        padding: 0.25rem;
        background-color: #fff;
        display: flex;
        width: 100%;
        max-width: 350px;
    }
    .search-form-custom .form-control {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }

    .sticky-post {
      background-color: #fffbe6;
      border-left: 4px solid #ffc107;
      padding-left: 20px;
    }
    .post-meta-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1rem;
        color: #6c757d;
        font-size: 0.875rem;
    }
    .post-meta-item .far {
        margin-right: 0.35rem;
    }
    .topic-title {
        font-size: 1.1rem;
        font-weight: 500;
    }
    .topic-details {
        font-size: 0.85rem;
    }
</style>

<!-- [SỬA] Thêm my-5 để tạo khoảng cách với header -->
<div class="container-fluid px-lg-5 my-5">
    <div class="row">
        <!-- Cột Nội Dung Chính -->
        <div class="col-lg-9">
            <!-- Header -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <div>
                    <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                    <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
                </div>
            </div>

            <!-- Bố cục bộ lọc và tìm kiếm MỚI -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center border-bottom pb-3 mb-3 category-nav">
                        <strong class="me-3">Danh mục:</strong>
                        <ul class="nav nav-pills">
                            <li class="nav-item"><a class="nav-link <%= (!filters || !filters.category || filters.category === 'all') ? 'active' : '' %>" href="?sort=<%= (filters && filters.sort) ? filters.sort : 'latest' %>&category=all">Tất cả bài đăng</a></li>
                            <% if (locals.categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { if (cat && cat._id) { %>
                                    <li class="nav-item"><a class="nav-link <%= (filters && filters.category === cat._id) ? 'active' : '' %>" href="?sort=<%= (filters && filters.sort) ? filters.sort : 'latest' %>&category=<%= cat._id %>"><%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %></a></li>
                                <% }}); %>
                            <% } %>
                        </ul>
                    </div>
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <ul class="nav nav-pills filter-nav mb-3 mb-md-0">
                            <li class="nav-item"><a class="nav-link <%= (!filters || !filters.sort || filters.sort === 'latest') ? 'active' : '' %>" href="?sort=latest&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Mới nhất</a></li>
                            <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'popular') ? 'active' : '' %>" href="?sort=popular&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Nổi bật</a></li>
                            <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'discussed') ? 'active' : '' %>" href="?sort=discussed&category=<%= (filters && filters.category) ? filters.category : 'all' %>">Thảo luận nhiều</a></li>
                        </ul>
                        <form action="/forum" method="GET" class="d-flex search-form-custom">
                            <input type="hidden" name="sort" value="<%= (filters && filters.sort) ? filters.sort : 'latest' %>">
                            <input type="hidden" name="category" value="<%= (filters && filters.category) ? filters.category : 'all' %>">
                            <input type="text" name="q" class="form-control border-0 shadow-none" placeholder="Tìm kiếm chủ đề..." value="<%= (filters && filters.q) ? filters.q : '' %>">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <% if (typeof error !== 'undefined' && error) { %><div class="alert alert-danger"><%= error %></div><% } %>
            
            <!-- [KHÔI PHỤC] Toàn bộ phần hiển thị bài đăng -->
            <div class="list-group">
                <% if (posts && posts.length > 0) { %>
                    <%# --- CODE HIỂN THỊ DỮ LIỆU THẬT --- %>
                    <p>Hiển thị dữ liệu thật ở đây</p>
                <% } else { %>
                    <%# --- CODE HIỂN THỊ BÀI ĐĂNG MẪU --- %>
                    <%
                        const sampleStickyPosts = [{_id: 'sticky1', title: 'Nội quy diễn đàn và hướng dẫn cho thành viên mới', author: { username: 'Admin' }, category: 'thong-bao', likesCount: 150, commentsCount: 25, views: 2500, lastActivity: new Date('2025-10-18T10:00:00Z'), externalUrl: 'https://kenh14.vn/netizen-la-gi-va-van-hoa-ung-xu-tren-mang-xa-hoi-20220908122435733.chn'}];
                        let samplePosts = [
                            { _id: 'sample1', title: 'Kinh nghiệm "săn" học bổng Vallet cho sinh viên', author: { username: 'maianh' }, category: 'hoc-tap', likesCount: 98, commentsCount: 22, views: 850, lastActivity: new Date('2025-10-19T14:00:00Z'), externalUrl: 'https://svvn.tienphong.vn/bi-quyet-san-hoc-bong-vallet-danh-cho-tan-sinh-vien-post1473216.tpo' },
                            { _id: 'sample2', title: 'Review các CLB/Đội/Nhóm: Đâu là nơi dành cho bạn?', author: { username: 'hoang_k69' }, category: 'ngoai-khoa', likesCount: 55, commentsCount: 42, views: 1200, lastActivity: new Date('2025-10-19T11:30:00Z'), externalUrl: 'https://vnu.edu.vn/tin-tuc-su-kien/-/tin-tuc/cau-lac-bo-doi-nhom-sinh-vien-vnu-noi-ket-noi-dam-me-va-toa-sang-tai-nang.vnu' },
                            { _id: 'sample3', title: 'Tips ôn thi cuối kỳ hiệu quả môn Triết học?', author: { username: 'baongan_log' }, category: 'hoc-tap', likesCount: 72, commentsCount: 15, views: 600, lastActivity: new Date('2025-10-19T15:00:00Z'), externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-su-pham-ky-thuat-thanh-pho-ho-chi-minh/triet-hoc-mac-lenin/de-cuong-on-tap-cuoi-ki-triet-hoc-mac-lenin/24581452' },
                        ];
                        const sortType = (locals.filters && filters.sort) ? filters.sort : 'latest';
                        if (sortType === 'popular') { samplePosts.sort((a, b) => b.likesCount - a.likesCount); } 
                        else if (sortType === 'discussed') { samplePosts.sort((a, b) => b.commentsCount - a.commentsCount); } 
                        else { samplePosts.sort((a, b) => b.lastActivity - a.lastActivity); }

                        sampleStickyPosts.forEach(post => { %>
                            <div class="list-group-item list-group-item-action post-item sticky-post">
                                <a href="<%= post.externalUrl %>" class="text-decoration-none text-dark stretched-link" target="_blank"><h5 class="mb-1 topic-title"><%= post.title %></h5></a>
                                <div class="topic-details">Ghim bởi <strong><%= post.author.username %></strong> &middot; <%= new Date(post.lastActivity).toLocaleDateString('vi-VN') %></div>
                                <div class="d-flex gap-3 text-muted mt-2"><span class="post-meta-item"><i class="far fa-thumbs-up"></i><%= post.likesCount %></span><span class="post-meta-item"><i class="far fa-comments"></i><%= post.commentsCount %></span><span class="post-meta-item"><i class="far fa-eye"></i><%= post.views %></span></div>
                            </div>
                        <% });
                        samplePosts.forEach(post => { %>
                            <div class="list-group-item list-group-item-action post-item">
                                <a href="<%= post.externalUrl %>" class="text-decoration-none text-dark stretched-link" target="_blank"><h5 class="mb-1 topic-title"><%= post.title %></h5></a>
                                <div class="topic-details">bởi <strong><%= post.author.username %></strong> &middot; <%= new Date(post.lastActivity).toLocaleDateString('vi-VN') %></div>
                                <div class="d-flex gap-3 text-muted mt-2"><span class="post-meta-item"><i class="far fa-thumbs-up"></i><%= post.likesCount %></span><span class="post-meta-item"><i class="far fa-comments"></i><%= post.commentsCount %></span><span class="post-meta-item"><i class="far fa-eye"></i><%= post.views %></span></div>
                            </div>
                        <% }); %>
                    <% } %>
            </div>
            
            <!-- Pagination -->
            <% if (posts && posts.length > 0 && totalPages > 1) { %>
                <%- include('../../partials/pagination', { currentPage: currentPage, totalPages: totalPages, baseUrl: `/forum?sort=${(filters && filters.sort) ? filters.sort : 'latest'}&category=${(filters && filters.category) ? filters.category : 'all'}&q=${(filters && filters.q) ? filters.q : ''}` }) %>
            <% } %>
        </div>

        <!-- Thanh Bên Phải -->
        <div class="col-lg-3">
            <%- include('../../partials/_forumSidebar', { totalPosts: totalPosts || 0, user: user || null }) %>
        </div>
    </div>
</div>

