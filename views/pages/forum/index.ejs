<style>
    /* CSS cho giao diện mới */
    .filters-sidebar {
        position: sticky;
        top: 6rem; /* Khoảng cách với header */
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: .75rem;
    }
    .filters-sidebar .form-group {
        margin-bottom: 1rem;
    }
    .post-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border-radius: .75rem !important;
        border: 1px solid #e0e0e0;
    }
    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .post-card .card-footer {
        background-color: #f8f9fa;
    }
    .post-meta-item {
        display: inline-flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.875rem;
    }
    .post-meta-item .fas {
        margin-right: 0.4rem;
    }
</style>

<div class="row">
    <!-- Cột Trái: Bộ lọc -->
    <div class="col-lg-3">
        <aside class="sidebar filters-sidebar">
            <h4><i class="fas fa-filter me-2"></i>Lọc & Sắp xếp</h4>
            <hr>
            <form action="/forum" method="GET" class="filter-form">
                <!-- Search Input -->
                <div class="form-group">
                    <label for="q" class="form-label fw-bold">Từ khóa</label>
                    <div class="input-group">
                         <input type="search" id="q" name="q" class="form-control" placeholder="Tên bài đăng..." value="<%= (filters && filters.q) ? filters.q : '' %>">
                    </div>
                </div>

                <!-- Category Dropdown -->
                <div class="form-group">
                    <label for="category" class="form-label fw-bold">Chuyên mục</label>
                    <select name="category" id="category" class="form-select">
                        <option value="all">Tất cả chuyên mục</option>
                        <% if (categories && categories.length > 0) { %>
                            <% categories.forEach(cat => { %>
                                <% if (cat && cat._id) { %>
                                    <option value="<%= cat._id %>" <%= (filters && filters.category === cat._id) ? 'selected' : '' %>>
                                        <%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %> (<%= cat.count %>)
                                    </option>
                                <% } %>
                            <% }); %>
                        <% } else { %>
                            <option value="hoc-tap" <%= (filters && filters.category === 'hoc-tap') ? 'selected' : '' %>>Học tập</option>
                            <option value="ngoai-khoa" <%= (filters && filters.category === 'ngoai-khoa') ? 'selected' : '' %>>Ngoại khóa</option>
                            <option value="doi-song" <%= (filters && filters.category === 'doi-song') ? 'selected' : '' %>>Đời sống</option>
                        <% } %>
                    </select>
                </div>

                <!-- Sort Dropdown -->
                <div class="form-group">
                    <label for="sort" class="form-label fw-bold">Sắp xếp theo</label>
                    <select name="sort" id="sort" class="form-select">
                        <option value="latest" <%= (filters && filters.sort === 'latest') ? 'selected' : '' %>>Mới nhất</option>
                        <option value="popular" <%= (filters && filters.sort === 'popular') ? 'selected' : '' %>>Nổi bật</option>
                        <option value="discussed" <%= (filters && filters.sort === 'discussed') ? 'selected' : '' %>>Thảo luận nhiều</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-2">Áp dụng</button>
            </form>
        </aside>
    </div>

    <!-- Cột Phải: Danh sách bài đăng -->
    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
            </div>
            <a href="/forum/create" class="btn btn-primary btn-lg d-none d-md-inline-flex">
                <i class="fas fa-plus-circle me-2"></i> Tạo chủ đề
            </a>
        </div>
        
        <% if (posts && posts.length > 0) { %>
            <%# --- PHẦN DÀNH CHO DỮ LIỆU THẬT --- %>
            <div class="d-flex justify-content-between align-items-center mb-3">
                 <p class="mb-0 text-muted">Hiển thị <%= posts.length %> trong tổng số <%= totalPosts %> kết quả</p>
            </div>
             <div class="row row-cols-1 g-4">
                <% posts.forEach(post => { %>
                    <div class="col">
                        <div class="card h-100 post-card">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title"><a href="/forum/post/<%= post._id %>" class="text-decoration-none stretched-link"><%= post.title %></a></h5>
                                <small class="text-muted">bởi <strong><%= post.author ? post.author.username : 'N/A' %></strong> &middot; <%= new Date(post.lastActivity).toLocaleDateString('vi-VN') %></small>
                                <div class="mt-auto pt-3">
                                     <a href="/forum/post/<%= post._id %>" class="btn btn-sm btn-outline-primary">Xem chi tiết</a>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-around">
                                <span class="post-meta-item" title="Lượt thích"><i class="fas fa-thumbs-up"></i> <%= post.likesCount || 0 %></span>
                                <span class="post-meta-item" title="Bình luận"><i class="fas fa-comment-alt"></i> <%= post.commentsCount || 0 %></span>
                                <span class="post-meta-item" title="Lượt xem"><i class="fas fa-eye"></i> <%= post.views || 0 %></span>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
             <!-- Phân trang -->
            <% if (totalPages > 1) { %>
                <%- include('../../partials/pagination', {
                    currentPage: currentPage, totalPages: totalPages,
                    baseUrl: `/forum?sort=${(filters && filters.sort) || ''}&category=${(filters && filters.category) || 'all'}&q=${(filters && filters.q) || ''}`
                }) %>
            <% } %>

        <% } else { %>
            <%# --- PHẦN DÀNH CHO DỮ LIỆU MẪU --- %>
            <%
                const allSamplePosts = [
                    { _id: 'sample1', title: 'Kinh nghiệm "săn" học bổng Vallet', author: { username: 'maianh' }, likesCount: 98, commentsCount: 22, views: 850, createdAt: '2025-10-19T14:00:00Z', category: 'hoc-tap', externalUrl: 'https://svvn.tienphong.vn/bi-quyet-san-hoc-bong-vallet-danh-cho-tan-sinh-vien-post1473216.tpo' },
                    { _id: 'sample2', title: 'Review các CLB/Đội/Nhóm: Đâu là nơi dành cho bạn?', author: { username: 'hoang_k69' }, likesCount: 55, commentsCount: 42, views: 1200, createdAt: '2025-10-19T11:30:00Z', category: 'ngoai-khoa', externalUrl: 'https://vnu.edu.vn/tin-tuc-su-kien/-/tin-tuc/cau-lac-bo-doi-nhom-sinh-vien-vnu-noi-ket-noi-dam-me-va-toa-sang-tai-nang.vnu' },
                    { _id: 'sample3', title: 'Tips ôn thi cuối kỳ hiệu quả môn Triết học?', author: { username: 'baongan_log' }, likesCount: 72, commentsCount: 15, views: 600, createdAt: '2025-10-19T15:00:00Z', category: 'hoc-tap', externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-su-pham-ky-thuat-thanh-pho-ho-chi-minh/triet-hoc-mac-lenin/de-cuong-on-tap-cuoi-ki-triet-hoc-mac-lenin/24581452' },
                    { _id: 'sample4', title: 'Tìm nhà trọ gần trường: Những điều cần lưu ý!', author: { username: 'minhduc' }, likesCount: 30, commentsCount: 18, views: 950, createdAt: '2025-10-18T09:00:00Z', category: 'doi-song', externalUrl: 'https://thanhnien.vn/bi-kip-tim-phong-tro-cho-tan-sinh-vien-post1492520.html' },
                    { _id: 'sample5', title: 'Tổng hợp các quán ăn vặt ngon-bổ-rẻ quanh khu vực trường', author: { username: 'foodlover' }, likesCount: 125, commentsCount: 58, views: 2100, createdAt: '2025-10-19T08:00:00Z', category: 'doi-song', externalUrl: 'https://toplist.vn/top-list/quan-an-vat-ngon-gan-dai-hoc-khoa-hoc-xa-hoi-va-nhan-van-tp-hcm-41808.htm' },
                    { _id: 'sample6', title: 'Làm thế nào để cân bằng giữa việc học và đi làm thêm?', author: { username: 'thanh_tam' }, likesCount: 88, commentsCount: 35, views: 1500, createdAt: '2025-10-18T16:00:00Z', category: 'doi-song', externalUrl: 'https://glints.com/vn/blog/cach-can-bang-giua-viec-hoc-va-lam/' },
                    { _id: 'sample7', title: 'Hướng dẫn đăng ký thi VNU-EPT chi tiết', author: { username: 'anhkhoa' }, likesCount: 110, commentsCount: 25, views: 1800, createdAt: '2025-10-17T10:00:00Z', category: 'hoc-tap', externalUrl: 'https://vnuhcm.edu.vn/sinh-vien_33346864/huong-dan-dang-ky-thi-danh-gia-nang-luc-tieng-anh-vnu-ept-tren-cong-thong-tin-thi-dgnl-cua-dhqg-hcm/313635356864.html' },
                    { _id: 'sample8', title: 'Cẩm nang sinh tồn KTX khu B ĐHQG', author: { username: 'tramy' }, likesCount: 250, commentsCount: 95, views: 4500, createdAt: '2025-10-16T20:00:00Z', category: 'doi-song', externalUrl: 'https://www.facebook.com/sinhvien.dhqghcm/posts/1349581728419614/' },
                    { _id: 'sample9', title: 'Tham gia CLB Guitar USSH như thế nào?', author: { username: 'guitarist' }, likesCount: 180, commentsCount: 30, views: 3200, createdAt: '2025-10-15T08:30:00Z', category: 'ngoai-khoa', externalUrl: 'https://www.facebook.com/clbguitar.ussh/' },
                    { _id: 'sample10', title: 'Đội Công tác xã hội USSH tuyển thành viên', author: { username: 'ctxh_ussh' }, likesCount: 60, commentsCount: 12, views: 700, createdAt: '2025-10-14T11:00:00Z', category: 'ngoai-khoa', externalUrl: 'https://www.facebook.com/CTXH.USSH/' },
                ];
                let filteredSamplePosts = allSamplePosts;
                if (filters && filters.category && filters.category !== 'all') {
                    filteredSamplePosts = filteredSamplePosts.filter(post => post.category === filters.category);
                }
                const sortType = (filters && filters.sort) ? filters.sort : 'latest';
                if (sortType === 'popular') { filteredSamplePosts.sort((a, b) => b.views - a.views); } 
                else if (sortType === 'discussed') { filteredSamplePosts.sort((a, b) => b.commentsCount - a.commentsCount); } 
                else { filteredSamplePosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); }
                
                const postsPerPage = 5;
                const page = currentPage || 1;
                const totalSamplePosts = filteredSamplePosts.length;
                const totalSamplePages = Math.ceil(totalSamplePosts / postsPerPage);
                const paginatedSamplePosts = filteredSamplePosts.slice((page - 1) * postsPerPage, page * postsPerPage);
            %>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <p class="mb-0 text-muted">Hiển thị <%= paginatedSamplePosts.length %> trong tổng số <%= totalSamplePosts %> kết quả</p>
            </div>
            
            <% if (paginatedSamplePosts.length > 0) { %>
                <div class="row row-cols-1 g-4">
                    <% paginatedSamplePosts.forEach(post => { %>
                        <div class="col">
                            <div class="card h-100 post-card">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title"><a href="<%= post.externalUrl %>" target="_blank" class="text-decoration-none stretched-link"><%= post.title %></a></h5>
                                    <small class="text-muted">bởi <strong><%= post.author.username %></strong> &middot; <%= new Date(post.createdAt).toLocaleDateString('vi-VN') %></small>
                                    <div class="mt-auto pt-3">
                                         <a href="<%= post.externalUrl %>" target="_blank" class="btn btn-sm btn-outline-primary">Xem chi tiết <i class="fas fa-external-link-alt ms-1"></i></a>
                                    </div>
                                </div>
                                <div class="card-footer d-flex justify-content-around">
                                    <span class="post-meta-item" title="Lượt thích"><i class="fas fa-thumbs-up"></i> <%= post.likesCount %></span>
                                    <span class="post-meta-item" title="Bình luận"><i class="fas fa-comment-alt"></i> <%= post.commentsCount %></span>
                                    <span class="post-meta-item" title="Lượt xem"><i class="fas fa-eye"></i> <%= post.views %></span>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
                 <!-- Phân trang -->
                <% if (totalSamplePages > 1) { %>
                    <%- include('../../partials/pagination', {
                        currentPage: page, totalPages: totalSamplePages,
                        baseUrl: `/forum?sort=${(filters && filters.sort) || ''}&category=${(filters && filters.category) || 'all'}&q=${(filters && filters.q) || ''}`
                    }) %>
                <% } %>
            <% } else { %>
                <div class="alert alert-info text-center">Không tìm thấy bài đăng nào phù hợp.</div>
            <% } %>
        <% } %>
    </div>
</div>

