<style>
    /* Các style tùy chỉnh cho diễn đàn */
    .info-card {
        border-radius: .75rem;
    }
    .filter-nav .nav-link { 
        color: #6c757d; 
        border-bottom: 3px solid transparent; 
        padding: 0.5rem 0;
        margin-right: 1.5rem;
        transition: all 0.2s ease-in-out; 
    }
    .filter-nav .nav-link.active, .filter-nav .nav-link:hover { 
        color: #0d6efd; 
        border-bottom-color: #0d6efd; 
        font-weight: 500; 
    }
    .post-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .post-card .card-footer {
        background-color: #f8f9fa;
    }
    .post-meta-item {
        display: inline-flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.875rem;
    }
    .post-meta-item .fas {
        margin-right: 0.4rem;
    }
    .filter-card .form-group {
        margin-bottom: 1rem;
    }
</style>

<!-- Thẻ div container-fluid đã được loại bỏ để khớp với layout chính -->
<div class="row">
    <!-- Cột Nội Dung Chính -->
    <div class="col-lg-9">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 mb-3 mb-md-0">
                <div class="card h-100 info-card">
                    <div class="card-body">
                        <!-- [SỬA 1] Viết thường lại tiêu đề -->
                        <h5 class="card-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Nội quy diễn đàn USSH</h5>
                        <p class="card-text" style="font-size: 1.0rem; line-height: 1.6;">
                            <b>1. Tôn trọng:</b> Không công kích cá nhân, tranh luận bằng lý lẽ.<br>
                            <b>2. Trung thực:</b> Ghi rõ nguồn khi trích dẫn, không lan truyền tin sai.<br>
                            <b>3. Sạch sẽ:</b> Không spam, quảng cáo, hay đăng bài phản cảm.<br>
                            <b>4. Lịch sự:</b> Dùng tiếng Việt rõ ràng, tránh ngôn ngữ tục tĩu.<br>
                            <b>5. Đúng chủ đề:</b> Đăng bài đúng chuyên mục.<br>
                            <b>6. Có ý thức:</b> Không đăng hình ảnh riêng tư, xâm phạm người khác.<br>
                            <b>7. Trách nhiệm:</b> Một người – một tài khoản. Bạn chịu trách nhiệm cho phát ngôn của mình.<br>
                            <b>8. Cùng xây dựng:</b> Chia sẻ tài liệu, hỗ trợ nhau học tập và phản biện văn minh.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- [SỬA 2] Thiết kế lại thành bộ lọc kiểu học tập -->
                <div class="card h-100 info-card filter-card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-filter me-2"></i>Lọc & Tìm kiếm</h5>
                        <form action="/forum" method="GET" class="mt-3">
                            <div class="form-group">
                                <label for="category" class="form-label small fw-bold">Chuyên mục</label>
                                <select name="category" id="category" class="form-select">
                                    <option value="all">Tất cả bài đăng (<%= (typeof totalPosts !== 'undefined' && totalPosts > 0) ? totalPosts : 10 %>)</option>
                                     <% if (categories && categories.length > 0) { %>
                                        <% categories.forEach(cat => { if (cat && cat._id) { %>
                                            <option value="<%= cat._id %>" <%= (filters && filters.category === cat._id) ? 'selected' : '' %>>
                                                <%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %> (<%= cat.count %>)
                                            </option>
                                        <% }}) %>
                                    <% } else { %>
                                        <option value="hoc-tap" <%= (filters && filters.category === 'hoc-tap') ? 'selected' : '' %>>Học tập (4)</option>
                                        <option value="ngoai-khoa" <%= (filters && filters.category === 'ngoai-khoa') ? 'selected' : '' %>>Ngoại khóa (2)</option>
                                        <option value="doi-song" <%= (filters && filters.category === 'doi-song') ? 'selected' : '' %>>Đời sống (4)</option>
                                    <% } %>
                                </select>
                            </div>
                             <div class="form-group">
                                <label for="sort" class="form-label small fw-bold">Sắp xếp theo</label>
                                <select name="sort" id="sort" class="form-select">
                                    <option value="latest" <%= (filters && filters.sort === 'latest') ? 'selected' : '' %>>Mới nhất</option>
                                    <option value="popular" <%= (filters && filters.sort === 'popular') ? 'selected' : '' %>>Nổi bật</option>
                                    <option value="discussed" <%= (filters && filters.sort === 'discussed') ? 'selected' : '' %>>Thảo luận nhiều</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mt-2">Áp dụng</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách bài đăng -->
        <div>
            <div class="row row-cols-1 row-cols-lg-2 g-4">
                <% if (posts && posts.length > 0) { %>
                    <%# --- PHẦN NÀY DÀNH CHO DỮ LIỆU THẬT --- %>
                <% } else { %>
                    <%# --- PHẦN BÀI ĐĂNG MẪU VỚI LOGIC MỚI --- %>
                    <%
                        const allSamplePosts = [
                            { _id: 'sample1', title: 'Kinh nghiệm "săn" học bổng Vallet cho sinh viên', author: { username: 'mailam' }, category: 'hoc-tap', likesCount: 98, commentsCount: 22, views: 850, createdAt: '2025-10-19T14:00:00Z', externalUrl: 'https://fr.scribd.com/document/681416552/H%E1%BB%93-S%C6%A1-D%E1%BB%B1-An-Xin-H%E1%BB%8Dc-B%E1%BB%95ng' },
                            { _id: 'sample2', title: 'Review các CLB/Đội/Nhóm: Đâu là nơi dành cho bạn?', author: { username: 'uete' }, category: 'ngoai-khoa', likesCount: 55, commentsCount: 42, views: 1200, createdAt: '2025-10-19T11:30:00Z', externalUrl: 'https://ussh.vnu.edu.vn/vi/gioi-thieu/doan-thanh-nien-hoi-sinh-vien/cac-clb-doi-nhom-18060.html' },
                            { _id: 'sample3', title: 'Tips ôn thi cuối kỳ hiệu quả môn Triết học?', author: { username: 'giabinhgroup' }, category: 'hoc-tap', likesCount: 72, commentsCount: 15, views: 600, createdAt: '2025-10-19T15:00:00Z', externalUrl: 'https://docx.com.vn/tai-lieu/tai-lieu-on-tap-thi-cuoi-ki-mon-triet-hoc-mac-lenin-truong-dai-hoc-ngo-79911' },
                            { _id: 'sample4', title: 'Tìm nhà trọ gần trường: Những điều cần lưu ý!', author: { username: 'lew' }, category: 'doi-song', likesCount: 30, commentsCount: 18, views: 950, createdAt: '2025-10-18T09:00:00Z', externalUrl: 'https://khoedep24gio.com/tim-nha-tro-can-luu-y-nhung-gi-goc-chia-se-tu-alo-nha-tro/' },
                            { _id: 'sample5', title: 'Tổng hợp các quán ăn vặt ngon-bổ-rẻ quanh khu vực trường', author: { username: 'trangchoiban' }, category: 'doi-song', likesCount: 125, commentsCount: 58, views: 2100, createdAt: '2025-10-19T08:00:00Z', externalUrl: 'https://www.coolmate.me/blog/quan-an-vat-thanh-xuan-ha-noi-487' },
                            { _id: 'sample6', title: 'Làm thế nào để cân bằng giữa việc học và đi làm thêm?', author: { username: 'thaooo' }, category: 'hoc-tap', likesCount: 88, commentsCount: 35, views: 1500, createdAt: '2025-10-18T16:00:00Z', externalUrl: 'https://glints.com/vn/blog/cach-can-bang-giua-viec-hoc-va-lam/' },
                            { _id: 'sample7', title: 'Hướng dẫn đăng ký thi VNU-EPT chi tiết', author: { username: 'toilak69' }, category: 'hoc-tap', likesCount: 110, commentsCount: 25, views: 1800, createdAt: '2025-10-17T10:00:00Z', externalUrl: 'https://anhnguthienan.edu.vn/khoa-hoc/luyen-thi-vnu-ept/' },
                            { _id: 'sample8', title: 'Cẩm nang sinh tồn KTX khu B ĐHQG', author: { username: 'admin' }, category: 'doi-song', likesCount: 250, commentsCount: 95, views: 4500, createdAt: '2025-10-16T20:00:00Z', externalUrl: 'https://ussh.vnu.edu.vn/vi/sinh-vien/hoat-dong/danh-cho-tan-sinh-vien-k69-cam-nang-su-dung-hoc-lieu-cua-trung-tam-thu-vien-va-tri-thuc-so-vnu-lic-19317.html' },
                            { _id: 'sample9', title: 'Các tuyến xe buýt chính đến trường và khu vực lân cận', author: { username: '5nanglinhngulam' }, category: 'doi-song', likesCount: 180, commentsCount: 30, views: 3200, createdAt: '2025-10-15T08:30:00Z', externalUrl: 'https://thi.tuyensinh247.com/cac-tuyen-xe-buyt-di-qua-truong-dai-hoc-khoa-hoc-xa-hoi-va-nhan-van-dhqghn-c24a40642.html' },
                            { _id: 'sample10', title: 'Tuyển thành viên CLB Guitar USSH', author: { username: 'guitarclub' }, category: 'ngoai-khoa', likesCount: 150, commentsCount: 60, views: 2800, createdAt: '2025-10-14T11:00:00Z', externalUrl: 'https://www.facebook.com/clbguitar.ussh/' },
                        ];
                        
                        let filteredSamplePosts = allSamplePosts;
                        const categoryFilter = (filters && filters.category) ? filters.category : 'all';
                        if (categoryFilter !== 'all') {
                            filteredSamplePosts = filteredSamplePosts.filter(p => p.category === categoryFilter);
                        }

                        const sortType = (filters && filters.sort) ? filters.sort : 'latest';
                        if (sortType === 'popular') { filteredSamplePosts.sort((a, b) => b.views - a.views); } 
                        else if (sortType === 'discussed') { filteredSamplePosts.sort((a, b) => b.commentsCount - a.commentsCount); } 
                        else { filteredSamplePosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); }
                        
                        const postsPerPage = 5;
                        const totalSamplePages = Math.ceil(filteredSamplePosts.length / postsPerPage);
                        const page = currentPage || 1;
                        const paginatedSamplePosts = filteredSamplePosts.slice((page - 1) * postsPerPage, page * postsPerPage);
                    %>
                    <% if (paginatedSamplePosts.length > 0) { %>
                        <% paginatedSamplePosts.forEach(post => { %>
                            <div class="col">
                                <div class="card h-100 post-card">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title"><a href="<%= post.externalUrl %>" target="_blank" class="text-decoration-none stretched-link"><%= post.title %></a></h5>
                                        <small class="text-muted">bởi <strong><%= post.author.username %></strong> &middot; <%= new Date(post.createdAt).toLocaleDateString('vi-VN') %></small>
                                        <div class="mt-auto pt-3">
                                             <a href="<%= post.externalUrl %>" target="_blank" class="btn btn-sm btn-outline-primary">Xem chi tiết <i class="fas fa-external-link-alt ms-1"></i></a>
                                        </div>
                                    </div>
                                    <div class="card-footer d-flex justify-content-around">
                                        <span class="post-meta-item" title="Lượt thích"><i class="fas fa-thumbs-up"></i> <%= post.likesCount %></span>
                                        <span class="post-meta-item" title="Bình luận"><i class="fas fa-comment-alt"></i> <%= post.commentsCount %></span>
                                        <span class="post-meta-item" title="Lượt xem"><i class="fas fa-eye"></i> <%= post.views %></span>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12"><p class="text-center text-muted mt-4">Không có bài đăng nào trong mục này.</p></div>
                    <% } %>
                    
                    <% if (totalSamplePages > 1) { %>
                        <%- include('../../partials/pagination', {
                            currentPage: page, 
                            totalPages: totalSamplePages,
                            baseUrl: `/forum?sort=${sortType}&category=${categoryFilter}&q=${(filters && filters.q) || ''}`
                        }) %>
                    <% } %>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Thanh Bên Phải -->
<div class="col-lg-3">
    <%- include('../../partials/_forumSidebar', { totalPosts: totalPosts, user: user || null }) %>
</div>
<style>
    #forum-pagination {
        /* Thêm khoảng cách 1.5rem (khoảng 24px) ở dưới thanh phân trang */
        margin-bottom: 1.5rem; 
    }
    @media (max-width: 991.98px) {
        #create-post-header-btn {
            display: none; /* Ẩn nút trên header */
        }
    }
</style>
