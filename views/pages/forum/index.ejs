<style>
    /* Các style tùy chỉnh cho diễn đàn */
    .category-card .list-group-item {
        border-radius: 0;
        border-left: 0;
        border-right: 0;
        padding: 0.75rem 1.25rem;
    }
    .category-card .list-group-item:first-child { border-top: 0; }
    .category-card .list-group-item:last-child { border-bottom: 0; }

    .filter-nav .nav-link { 
        color: #6c757d; 
        border-bottom: 3px solid transparent; 
        padding: 0.5rem 0;
        margin-right: 1.5rem;
        transition: all 0.2s ease-in-out; 
    }
    .filter-nav .nav-link.active, .filter-nav .nav-link:hover { 
        color: #0d6efd; 
        border-bottom-color: #0d6efd; 
        font-weight: 500; 
    }
    .post-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .post-card .card-footer {
        background-color: #f8f9fa;
    }
    .post-meta-item {
        display: inline-flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.875rem;
    }
    .post-meta-item .fas {
        margin-right: 0.4rem;
    }
</style>

<!-- Thẻ div container-fluid đã được loại bỏ để khớp với layout chính -->
<div class="row">
    <!-- Cột Nội Dung Chính -->
    <div class="col-lg-9">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <div>
                <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
            </div>
        </div>

        <!-- 1. Nội quy và hướng dẫn -->
        <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <strong>Nội quy diễn đàn:</strong> Tôn trọng lẫn nhau, không chia sẻ thông tin cá nhân nhạy cảm và giữ một môi trường thảo luận văn minh, tích cực. 
                <a href="#" class="alert-link">Xem chi tiết tại đây</a>.
            </div>
        </div>

        <!-- 2. Bố cục bộ lọc và danh mục MỚI -->
        <div class="row">
            <!-- Cột Danh mục -->
            <div class="col-md-4">
                <div class="card category-card mb-4">
                    <div class="card-header fw-bold">
                        Danh mục bài đăng
                    </div>
                    <ul class="list-group list-group-flush">
                        <a href="?sort=<%= (filters && filters.sort) || 'latest' %>&category=all" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center <%= (!filters || !filters.category || filters.category === 'all') ? 'active' : '' %>">
                            Tất cả bài đăng
                            <span class="badge bg-primary rounded-pill"><%= totalPosts || 'N/A' %></span>
                        </a>
                        <% if (categories && categories.length > 0) { %>
                            <% categories.forEach(cat => { if (cat && cat._id) { %>
                                <a href="?sort=<%= (filters && filters.sort) || 'latest' %>&category=<%= cat._id %>" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center <%= (filters && filters.category === cat._id) ? 'active' : '' %>">
                                    <%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %>
                                    <span class="badge bg-secondary rounded-pill"><%= cat.count %></span>
                                </a>
                            <% }}) %>
                        <% } %>
                    </ul>
                </div>
            </div>

            <!-- Cột Bộ lọc và Bài đăng -->
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center border-bottom mb-3 pb-2">
                    <ul class="nav nav-pills filter-nav">
                        <li class="nav-item"><a class="nav-link <%= (!filters || !filters.sort || filters.sort === 'latest') ? 'active' : '' %>" href="?sort=latest&category=<%= (filters && filters.category) || 'all' %>">Mới nhất</a></li>
                        <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'popular') ? 'active' : '' %>" href="?sort=popular&category=<%= (filters && filters.category) || 'all' %>">Nổi bật</a></li>
                        <li class="nav-item"><a class="nav-link <%= (filters && filters.sort === 'discussed') ? 'active' : '' %>" href="?sort=discussed&category=<%= (filters && filters.category) || 'all' %>">Thảo luận nhiều</a></li>
                    </ul>
                </div>

                <!-- 3. Danh sách bài đăng theo layout MỚI -->
                <div class="row row-cols-1 row-cols-xl-2 g-4">
                    <% if (posts && posts.length > 0) { %>
                        <%# --- PHẦN NÀY DÀNH CHO DỮ LIỆU THẬT --- %>
                        <% posts.forEach(post => { %>
                            <div class="col">
                                <div class="card h-100 post-card">
                                    <div class="card-body">
                                        <h5 class="card-title"><a href="/forum/post/<%= post._id %>" class="text-decoration-none stretched-link"><%= post.title %></a></h5>
                                        <small class="text-muted">bởi <strong><%= post.author ? post.author.username : 'N/A' %></strong> &middot; <%= new Date(post.lastActivity).toLocaleDateString('vi-VN') %></small>
                                    </div>
                                    <div class="card-footer d-flex justify-content-around">
                                        <span class="post-meta-item" title="Lượt thích"><i class="fas fa-thumbs-up"></i> <%= post.likesCount || 0 %></span>
                                        <span class="post-meta-item" title="Bình luận"><i class="fas fa-comment-alt"></i> <%= post.commentsCount || 0 %></span>
                                        <span class="post-meta-item" title="Lượt xem"><i class="fas fa-eye"></i> <%= post.views || 0 %></span>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <%# --- PHẦN BÀI ĐĂNG MẪU KHI DATABASE TRỐNG --- %>
                        <%
                            let samplePosts = [
                                { _id: 'sample1', title: 'Kinh nghiệm "săn" học bổng Vallet cho sinh viên', author: { username: 'maianh' }, likesCount: 98, commentsCount: 22, views: 850, createdAt: '2025-10-19T14:00:00Z' },
                                { _id: 'sample2', title: 'Review các CLB/Đội/Nhóm: Đâu là nơi dành cho bạn?', author: { username: 'hoang_k69' }, likesCount: 55, commentsCount: 42, views: 1200, createdAt: '2025-10-19T11:30:00Z' },
                                { _id: 'sample3', title: 'Tips ôn thi cuối kỳ hiệu quả môn Triết học?', author: { username: 'baongan_log' }, likesCount: 72, commentsCount: 15, views: 600, createdAt: '2025-10-19T15:00:00Z' },
                                { _id: 'sample4', title: 'Tìm nhà trọ gần trường: Những điều cần lưu ý!', author: { username: 'minhduc' }, likesCount: 30, commentsCount: 18, views: 950, createdAt: '2025-10-18T09:00:00Z' },
                            ];
                            const sortType = (filters && filters.sort) ? filters.sort : 'latest';
                            if (sortType === 'popular') { samplePosts.sort((a, b) => b.views - a.views); } 
                            else if (sortType === 'discussed') { samplePosts.sort((a, b) => b.commentsCount - a.commentsCount); } 
                            else { samplePosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); }
                        %>
                        <% samplePosts.forEach(post => { %>
                            <div class="col">
                                <div class="card h-100 post-card">
                                    <div class="card-body">
                                        <h5 class="card-title"><a href="#" class="text-decoration-none stretched-link"><%= post.title %></a></h5>
                                        <small class="text-muted">bởi <strong><%= post.author.username %></strong> &middot; <%= new Date(post.createdAt).toLocaleDateString('vi-VN') %></small>
                                    </div>
                                    <div class="card-footer d-flex justify-content-around">
                                        <span class="post-meta-item" title="Lượt thích"><i class="fas fa-thumbs-up"></i> <%= post.likesCount %></span>
                                        <span class="post-meta-item" title="Bình luận"><i class="fas fa-comment-alt"></i> <%= post.commentsCount %></span>
                                        <span class="post-meta-item" title="Lượt xem"><i class="fas fa-eye"></i> <%= post.views %></span>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>

                <!-- Phân trang -->
                <% if (totalPages > 1) { %>
                    <%- include('../../partials/pagination', {
                        currentPage: currentPage, totalPages: totalPages,
                        baseUrl: `/forum?sort=${(filters && filters.sort) || 'latest'}&category=${(filters && filters.category) || 'all'}&q=${(filters && filters.q) || ''}`
                    }) %>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Thanh Bên Phải -->
    <div class="col-lg-3">
        <%- include('../../partials/_forumSidebar', { totalPosts: totalPosts || 0, user: user || null }) %>
    </div>
</div>

