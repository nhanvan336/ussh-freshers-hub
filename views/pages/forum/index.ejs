<style>
    /* Các style tùy chỉnh cho diễn đàn */
    .filter-nav .nav-link { color: #6c757d; border-bottom: 3px solid transparent; padding-bottom: 0.5rem; transition: all 0.2s ease-in-out; }
    .filter-nav .nav-link.active, .filter-nav .nav-link:hover { color: #0d6efd; border-bottom-color: #0d6efd; font-weight: 500; }

    .category-nav .nav-link { color: #212529; font-weight: 500; }
    .category-nav .nav-link.active { color: #0d6efd; }
    
    .post-item { transition: background-color 0.2s ease-in-out; }
    .post-item:hover { background-color: #f8f9fa; }
    
    .search-form-custom {
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        padding: 0.5rem 0.75rem;
        background-color: #fff;
    }
</style>

<div class="container-fluid px-lg-5 my-5">
    <div class="row">
        <!-- Cột Nội Dung Chính -->
        <div class="col-lg-9">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                <div>
                    <h1><i class="fas fa-comments text-success"></i> Diễn đàn cộng đồng</h1>
                    <p class="lead text-muted mb-0">Nơi sinh viên cùng nhau thảo luận và chia sẻ kinh nghiệm.</p>
                </div>
            </div>

            <!-- Bố cục bộ lọc và tìm kiếm MỚI -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Hàng 1: Danh mục -->
                    <div class="d-flex flex-wrap align-items-center border-bottom pb-3 mb-3 category-nav">
                        <strong class="me-3">Danh mục:</strong>
                        <ul class="nav nav-pills">
                            <li class="nav-item">
                                <a class="nav-link <%= (!filters.category || filters.category === 'all') ? 'active' : '' %>" href="?sort=<%= filters.sort || 'latest' %>&category=all">Tất cả bài đăng</a>
                            </li>
                            <% if (locals.categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { %>
                                    <% if (cat && cat._id) { %>
                                        <li class="nav-item">
                                            <a class="nav-link <%= filters.category === cat._id ? 'active' : '' %>" href="?sort=<%= filters.sort || 'latest' %>&category=<%= cat._id %>">
                                                <%= cat._id.charAt(0).toUpperCase() + cat._id.slice(1) %>
                                            </a>
                                        </li>
                                    <% } %>
                                <% }); %>
                            <% } %>
                        </ul>
                    </div>
                    <!-- Hàng 2: Bộ lọc con và Tìm kiếm -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <ul class="nav nav-pills filter-nav mb-3 mb-md-0">
                            <li class="nav-item"><a class="nav-link <%= (!filters.sort || filters.sort === 'latest') ? 'active' : '' %>" href="?sort=latest&category=<%= filters.category || 'all' %>">Mới nhất</a></li>
                            <li class="nav-item"><a class="nav-link <%= filters.sort === 'popular' ? 'active' : '' %>" href="?sort=popular&category=<%= filters.category || 'all' %>">Nổi bật</a></li>
                            <li class="nav-item"><a class="nav-link <%= filters.sort === 'discussed' ? 'active' : '' %>" href="?sort=discussed&category=<%= filters.category || 'all' %>">Thảo luận nhiều</a></li>
                        </ul>
                        <form action="/forum" method="GET" class="d-flex search-form-custom">
                            <input type="hidden" name="sort" value="<%= filters.sort || 'latest' %>">
                            <input type="hidden" name="category" value="<%= filters.category || 'all' %>">
                            <input type="text" name="q" class="form-control border-0" placeholder="Tìm kiếm chủ đề..." value="<%= filters.q || '' %>">
                            <button type="submit" class="btn btn-link text-secondary p-0 ps-2"><i class="fas fa-search"></i></button>
                        </form>
                    </div>
                </div>
            </div>

            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-danger"><%= error %></div>
            <% } %>

            <!-- Danh sách bài đăng -->
            <div class="list-group">
                <%# Logic hiển thị bài đăng (dữ liệu thật hoặc mẫu) %>
                <%- include('../../partials/_forumPostList', { posts, stickyPosts, currentPage, filters }) %>
            </div>

            <!-- Phân trang -->
            <% if (posts && posts.length > 0) { %>
                <%- include('../../partials/pagination', {
                    currentPage: currentPage, totalPages: totalPages,
                    baseUrl: `/forum?sort=${filters.sort || 'latest'}&category=${filters.category || 'all'}&q=${filters.q || ''}`
                }) %>
            <% } %>
        </div>

        <!-- Thanh Bên Phải -->
        <div class="col-lg-3">
            <%- include('../../partials/_forumSidebar', { totalPosts: totalPosts || 0, user: user || null }) %>
        </div>
    </div>
</div>

