<%# File: views/pages/learning-hub/index.ejs %>

<div class="page-header">
    <div class="container">
        <h1>Thư viện học tập</h1>
        <p class="subtitle">Khám phá, chia sẻ và tải về hàng ngàn tài liệu học thuật giá trị.</p>
        <% if (user) { %>
            <a href="/learning-hub/upload" class="btn btn-primary">
                <i class="fas fa-upload"></i> Tải lên tài liệu
            </a>
        <% } else { %>
            <a href="/login" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Đăng nhập để tải lên
            </a>
        <% } %>
    </div>
</div>

<div class="container page-content">
    <div class="row">
        <!-- Cột Trái: Bộ lọc -->
        <div class="col-lg-3">
            <aside class="sidebar filters-sidebar">
                <h4><i class="fas fa-filter"></i> Tìm kiếm & Lọc</h4>
                <form action="/learning-hub" method="GET" class="filter-form">
                    <!-- Search Input -->
                    <div class="form-group">
                        <label for="q">Từ khóa</label>
                        <div class="input-group">
                             <input type="search" id="q" name="q" class="form-control" placeholder="Tên tài liệu, môn học..." value="<%= typeof filters !== 'undefined' ? filters.q : '' %>">
                             <button type="submit" class="btn btn-secondary" aria-label="Tìm kiếm"><i class="fas fa-search"></i></button>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label for="category">Loại tài liệu</label>
                        <select name="category" id="category" class="form-control">
                            <option value="all">Tất cả</option>
                            <option value="lecture" <%= (filters && filters.category === 'lecture') ? 'selected' : '' %>>Bài giảng</option>
                            <option value="ebook" <%= (filters && filters.category === 'ebook') ? 'selected' : '' %>>Giáo trình/Ebook</option>
                            <option value="exam" <%= (filters && filters.category === 'exam') ? 'selected' : '' %>>Đề thi</option>
                            <option value="other" <%= (filters && filters.category === 'other') ? 'selected' : '' %>>Khác</option>
                        </select>
                    </div>

                    <!-- Subject -->
                    <div class="form-group">
                        <label for="subject">Môn học</label>
                        <select name="subject" id="subject" class="form-control">
                           <option value="all">Tất cả</option>
                           <% const subjects = [
                                "Báo chí", "Đông phương học", "Hàn Quốc học", 
                                "Quan hệ công chúng", "Thông tin - Thư viện", "Triết học",
                                "Xã hội học", "Quốc tế học", "Tâm lý học", "Ngành khác"
                           ]; %>
                           <% subjects.forEach(subject => { %>
                                <option value="<%= subject.replace(/\s/g, '-') %>" <%= (filters && filters.subject === subject.replace(/\s/g, '-')) ? 'selected' : '' %>><%= subject %></option>
                           <% }); %>
                        </select>
                    </div>

                    <!-- Sort -->
                    <div class="form-group">
                        <label for="sort">Sắp xếp theo</label>
                        <select name="sort" id="sort" class="form-control">
                            <option value="newest" <%= (filters && filters.sort === 'newest') ? 'selected' : '' %>>Mới nhất</option>
                            <option value="popular" <%= (filters && filters.sort === 'popular') ? 'selected' : '' %>>Phổ biến nhất</option>
                            <option value="rated" <%= (filters && filters.sort === 'rated') ? 'selected' : '' %>>Đánh giá cao</option>
                            <option value="oldest" <%= (filters && filters.sort === 'oldest') ? 'selected' : '' %>>Cũ nhất</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Áp dụng</button>
                </form>
            </aside>
        </div>

        <!-- Cột Phải: Danh sách tài liệu -->
        <div class="col-lg-9">
            <% if (typeof documents !== 'undefined' && documents.length > 0) { %>
                <%# --- PHẦN NÀY DÀNH CHO DỮ LIỆU THẬT TỪ DATABASE --- %>
                <div class="document-list-header">
                    <p>Hiển thị <strong><%= documents.length %></strong> trong tổng số <strong><%= totalDocuments %></strong> kết quả</p>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <% documents.forEach(doc => { %>
                        <div class="col">
                            <div class="card h-100 document-card">
                                <a href="/learning-hub/document/<%= doc._id %>" class="card-img-top-link">
                                    <div class="card-img-top-placeholder">
                                        <i class="fas fa-file-alt fa-3x"></i>
                                        <span class="file-type-badge"><%= doc.fileInfo.fileType.toUpperCase() %></span>
                                    </div>
                                </a>
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a href="/learning-hub/document/<%= doc._id %>"><%= doc.title %></a>
                                    </h5>
                                    <p class="card-text text-muted small"><%= doc.description.substring(0, 70) %>...</p>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between align-items-center">
                                         <small class="text-muted"><i class="fas fa-star text-warning"></i> <%= doc.averageRating.toFixed(1) %></small>
                                         <small class="text-muted"><i class="fas fa-download"></i> <%= doc.downloads %></small>
                                         <small class="text-muted"><i class="fas fa-eye"></i> <%= doc.views %></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>

                <!-- Phân trang cho dữ liệu thật -->
                <% if (totalPages > 1) { %>
                    <%- include('../../partials/pagination', { currentPage: currentPage, totalPages: totalPages, baseUrl: `/learning-hub?sort=${filters.sort}&category=${filters.category}&subject=${filters.subject}&q=${filters.q || ''}` }) %>
                <% } %>
            <% } else { %>
                <%# --- PHẦN BÀI ĐĂNG MẪU KHI DATABASE TRỐNG --- %>
                <%
                    const allSampleDocuments = [
                        { _id: 'sample1', title: 'Giáo trình Nhập môn Quan hệ Công chúng', description: 'Tài liệu cơ bản cho sinh viên ngành PR.', category: 'ebook', subject: 'Quan-hệ-công-chúng', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 152, views: 830, uploader: { username: 'thanhmai' }, externalUrl: 'https://123docz.net/document/2513429-giao-trinh-nhap-mon-quan-he-cong-chung-dh-van-lang.htm' },
                        { _id: 'sample2', title: 'Đề cương ôn tập Triết học Mác-Lênin', description: 'Tổng hợp câu hỏi và đáp án chi tiết.', category: 'exam', subject: 'Triết-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 210, views: 1200, uploader: { username: 'minhquan' }, externalUrl: 'https://hoatieu.vn/tai-lieu/de-cuong-on-tap-triet-hoc-mac-lenin-210632' },
                        { _id: 'sample3', title: 'Slide bài giảng Tâm lý học Giao tiếp', description: 'Bài giảng của TS. Huỳnh Văn Sơn.', category: 'lecture', subject: 'Tâm-lý-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.5, downloads: 95, views: 640, uploader: { username: 'hoangan' }, externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-su-pham-thanh-pho-ho-chi-minh/tam-ly-hoc/tam-ly-hoc-giao-tiep-ts-huynh-van-son/24376595' },
                        { _id: 'sample4', title: 'Giáo trình Lịch sử Quan hệ quốc tế', description: 'Tài liệu chuẩn của khoa Quốc tế học.', category: 'ebook', subject: 'Quốc-tế-học', fileInfo: { fileType: 'DOCX' }, averageRating: 4.7, downloads: 180, views: 950, uploader: { username: 'bichphuong' }, externalUrl: 'https://sachhoc.com/giao-trinh-lich-su-van-minh-the-gioi-pdf' },
                        { _id: 'sample5', title: 'Bài giảng Phân loại tài liệu thư viện', description: 'Slide chi tiết về các chuẩn phân loại.', category: 'lecture', subject: 'Thông-tin-Thư-viện', fileInfo: { fileType: 'PDF' }, averageRating: 4.6, downloads: 130, views: 780, uploader: { username: 'giabao' }, externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-tai-chinh-marketing/quan-tri-khach-san/bai-giang-quan-tri-khach-san-chuong-6/35348982' },
                        { _id: 'sample6', title: 'Tổng hợp đề thi môn Xã hội học đại cương', description: 'Bao gồm cả tự luận và trắc nghiệm qua các năm.', category: 'exam', subject: 'Xã-hội-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 88, views: 520, uploader: { username: 'thuychi' }, externalUrl: 'https://dethikiemtra.com/danh-sach-cau-hoi/cau-hoi-on-tap-mon-xa-hoi-hoc-dai-cuong-co-dap-an-8224/' },
                        { _id: 'sample7', title: 'Giáo trình cơ sở văn hóa phương Đông', description: 'Tài liệu dành cho ngành Đông phương học.', category: 'ebook', subject: 'Đông-phương-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.9, downloads: 115, views: 880, uploader: { username: 'namphong' }, externalUrl: 'https://vietnamdevcenter.com/giao-trinh-han-nom-co-so/' },
                        { _id: 'sample8', title: 'Kỹ năng viết cho Báo chí hiện đại', description: 'Tài liệu hướng dẫn các thể loại báo chí mới.', category: 'other', subject: 'Báo-chí', fileInfo: { fileType: 'DOCX' }, averageRating: 4.7, downloads: 75, views: 450, uploader: { username: 'hongnhung' }, externalUrl: 'https://ajc.hcma.vn/UserControls/Upload/files/2021/8/sach%20ky%20nang%20nghe%20bao.pdf' },
                        { _id: 'sample9', title: 'Đề thi cuối kỳ môn Xã hội học Gia đình', description: 'Đề thi của học kỳ 1 năm học 2024-2025.', category: 'exam', subject: 'Xã-hội-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.4, downloads: 60, views: 390, uploader: { username: 'quanghuy' }, externalUrl: 'https://khotrithucso.com/doc/p/tong-hop-de-thi-mon-van-hoc-viet-nam-trung-dai-289569' },
                        { _id: 'sample10', title: 'Nhập môn Hàn Quốc học', description: 'Tổng quan về Lịch sử, văn hóa và kinh tế Hàn Quốc.', category: 'lecture', subject: 'Hàn-Quốc-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 92, views: 610, uploader: { username: 'admin' }, externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-khoa-hoc-xa-hoi-va-nhan-van-dai-hoc-quoc-gia-ha-noi/han-quoc-hoc-nhap-mon/nhap-mon-han-quoc-hoc/44583196' },
                        { _id: 'sample11', title: 'Tổng hợp đề thi Chính sách đối ngoại Việt Nam', description: 'Các đề thi cuối kỳ và giữa kỳ qua các năm.', category: 'exam', subject: 'Quốc-tế-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.6, downloads: 140, views: 750, uploader: { username: 'anhtuan' }, externalUrl: 'https://123docz.net/document/424385-tong-hop-de-thi-mon-chinh-sach-doi-ngoai-cua-viet-nam.htm' },
                        { _id: 'sample12', title: 'Giáo trình Tâm lý học phát triển', description: 'Nghiên cứu sự phát triển tâm lý con người.', category: 'ebook', subject: 'Tâm-lý-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 190, views: 1100, uploader: { username: 'ngoclan' }, externalUrl: 'https://sachviet.edu.vn/giao-trinh-tam-ly-hoc-phat-trien-chu-bien-gs-ts-nguyen-van-dong/' },
                        { _id: 'sample13', title: 'Bài giảng Các lý thuyết Xã hội học', description: 'Slide bài giảng về các nhà lý thuyết kinh điển.', category: 'lecture', subject: 'Xã-hội-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.7, downloads: 105, views: 680, uploader: { username: 'trunghieu' }, externalUrl: 'https://www.studocu.com/vn/document/truong-dai-hoc-cong-doan/xa-hoi-hoc-dai-cuong/cac-ly-thuyet-xa-hoi-hoc-co-dien/38146743' },
                        { _id: 'sample14', title: 'Cẩm nang đạo đức nghề nghiệp nhà báo', description: 'Quy tắc và chuẩn mực đạo đức trong báo chí.', category: 'other', subject: 'Báo-chí', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 85, views: 550, uploader: { username: 'thaophuong' }, externalUrl: 'https://dangcongsan.vn/xay-dung-dang/10-quy-dinh-dao-duc-nghe-nghiep-nguoi-lam-bao-viet-nam-425232.html' },
                        { _id: 'sample15', title: 'Kỹ năng quản lý thời gian hiệu quả', description: 'Sách hướng dẫn các phương pháp quản lý thời gian.', category: 'ebook', subject: 'Ngành-khác', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 250, views: 1500, uploader: { username: 'admin' }, externalUrl: 'https://www.sachhayonline.com/tua-sach/ky-nang-quan-ly-thoi-gian-hieu-qua/96' }
                    ];

                    let filteredDocuments = allSampleDocuments;

                    // Lọc theo Category
                    if (filters && filters.category && filters.category !== 'all') {
                        filteredDocuments = filteredDocuments.filter(doc => doc.category === filters.category);
                    }
                    // Lọc theo Subject
                    if (filters && filters.subject && filters.subject !== 'all') {
                        filteredDocuments = filteredDocuments.filter(doc => doc.subject === filters.subject.replace(/\s/g, '-'));
                    }
                    // Lọc theo từ khóa tìm kiếm
                    if (filters && filters.q) {
                        const query = filters.q.toLowerCase();
                        filteredDocuments = filteredDocuments.filter(doc =>
                            doc.title.toLowerCase().includes(query) ||
                            doc.description.toLowerCase().includes(query)
                        );
                    }
                    
                    // Sắp xếp kết quả
                    const sortType = (filters && filters.sort) ? filters.sort : 'newest';
                    if (sortType === 'popular') {
                        filteredDocuments.sort((a, b) => b.downloads - a.downloads);
                    } else if (sortType === 'rated') {
                        filteredDocuments.sort((a, b) => b.averageRating - a.averageRating);
                    } else if (sortType === 'oldest') {
                        filteredDocuments.sort((a, b) => parseInt(a._id.replace('sample', '')) - parseInt(b._id.replace('sample', '')));
                    } else { // newest
                        filteredDocuments.sort((a, b) => parseInt(b._id.replace('sample', '')) - parseInt(a._id.replace('sample', '')));
                    }

                    // [THÊM MỚI] Logic phân trang cho dữ liệu mẫu
                    const docsPerPage = 10;
                    const totalSampleDocs = filteredDocuments.length;
                    const totalSamplePages = Math.ceil(totalSampleDocs / docsPerPage);
                    const startIndex = (currentPage - 1) * docsPerPage;
                    const paginatedDocs = filteredDocuments.slice(startIndex, startIndex + docsPerPage);
                %>
                
                <% if (paginatedDocs.length > 0) { %>
                    <div class="document-list-header">
                        <p>Hiển thị <strong><%= paginatedDocs.length %></strong> trên tổng số <strong><%= totalSampleDocs %></strong> tài liệu mẫu</p>
                    </div>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        <% paginatedDocs.forEach(doc => { %>
                            <div class="col">
                                <div class="card h-100 document-card">
                                    <a href="<%= doc.externalUrl %>" class="card-img-top-link" target="_blank">
                                        <div class="card-img-top-placeholder">
                                            <i class="fas fa-file-alt fa-3x"></i>
                                            <span class="file-type-badge"><%= doc.fileInfo.fileType.toUpperCase() %></span>
                                        </div>
                                    </a>
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <a href="<%= doc.externalUrl %>" target="_blank"><%= doc.title %></a>
                                        </h5>
                                        <p class="card-text text-muted small"><%= doc.description.substring(0, 70) %>...</p>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-flex justify-content-between align-items-center">
                                             <small class="text-muted"><i class="fas fa-star text-warning"></i> <%= doc.averageRating.toFixed(1) %></small>
                                             <small class="text-muted"><i class="fas fa-download"></i> <%= doc.downloads %></small>
                                             <small class="text-muted"><i class="fas fa-eye"></i> <%= doc.views %></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- [THÊM MỚI] Phân trang cho dữ liệu mẫu -->
                    <% if (totalSamplePages > 1) { %>
                        <%- include('../../partials/pagination', { 
                            currentPage: currentPage, 
                            totalPages: totalSamplePages, 
                            baseUrl: `/learning-hub?sort=${(filters && filters.sort) || 'newest'}&category=${(filters && filters.category) || 'all'}&subject=${(filters && filters.subject) || 'all'}&q=${(filters && filters.q) || ''}` 
                        }) %>
                    <% } %>

                <% } else { %>
                    <div class="alert alert-info text-center mt-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <h4>Không tìm thấy tài liệu nào.</h4>
                        <p>Không có tài liệu mẫu nào khớp với bộ lọc của bạn.</p>
                    </div>
                <% } %>
            <% } %>
        </div>
    </div>
</div>

