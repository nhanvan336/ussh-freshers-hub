<%# File: views/pages/learning-hub/index.ejs %>

<div class="page-header">
    <div class="container">
        <h1>Thư viện học tập</h1>
        <p class="subtitle">Khám phá, chia sẻ và tải về hàng ngàn tài liệu học thuật giá trị.</p>
        <% if (isAuthenticated) { %>
            <a href="/learning-hub/upload" target="_blank" rel="noopener noreferrer" class="btn btn-primary" id="learning-hub-upload-link">
                <i class="fas fa-upload"></i> Tải lên tài liệu
            </a>
        <% } else { %>
            <a href="/auth/login" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Đăng nhập để tải lên
            </a>
        <% } %>
    </div>
</div>

<div class="container page-content">
    <div class="row">
        <!-- Cột Trái: Bộ lọc -->
        <div class="col-lg-3">
            <aside class="sidebar filters-sidebar">
                <h4><i class="fas fa-filter"></i> Tìm kiếm & Lọc</h4>
                <form action="/learning-hub" method="GET" class="filter-form">
                    <!-- Search Input -->
                    <div class="form-group">
                        <label for="q">Từ khóa</label>
                        <div class="input-group">
                             <input type="search" id="q" name="q" class="form-control" placeholder="Tên tài liệu, môn học..." value="<%= typeof filters !== 'undefined' ? filters.q : '' %>">
                             <button type="submit" class="btn btn-secondary" aria-label="Tìm kiếm"><i class="fas fa-search"></i></button>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label for="category">Loại tài liệu</label>
                        <select name="category" id="category" class="form-control">
                            <option value="all">Tất cả</option>
                            <option value="lecture" <%= (filters && filters.category === 'lecture') ? 'selected' : '' %>>Bài giảng</option>
                            <option value="ebook" <%= (filters && filters.category === 'ebook') ? 'selected' : '' %>>Giáo trình/Ebook</option>
                            <option value="exam" <%= (filters && filters.category === 'exam') ? 'selected' : '' %>>Đề thi</option>
                            <option value="other" <%= (filters && filters.category === 'other') ? 'selected' : '' %>>Khác</option>
                        </select>
                    </div>

                    <!-- Subject -->
                    <div class="form-group">
                        <label for="subject">Môn học</label>
                        <select name="subject" id="subject" class="form-control">
                           <option value="all">Tất cả</option>
                           <% const subjects = [
                                "Báo chí", "Đông phương học", "Hàn Quốc học", 
                                "Quan hệ công chúng", "Thông tin - Thư viện", "Triết học",
                                "Xã hội học", "Quốc tế học", "Tâm lý học", "Ngành khác"
                           ]; %>
                           <% subjects.forEach(subject => { %>
                                <option value="<%= subject.replace(/\s/g, '-') %>" <%= (filters && filters.subject === subject.replace(/\s/g, '-')) ? 'selected' : '' %>><%= subject %></option>
                           <% }); %>
                        </select>
                    </div>

                    <!-- Sort -->
                    <div class="form-group">
                        <label for="sort">Sắp xếp theo</label>
                        <select name="sort" id="sort" class="form-control">
                            <option value="newest" <%= (filters && filters.sort === 'newest') ? 'selected' : '' %>>Mới nhất</option>
                            <option value="popular" <%= (filters && filters.sort === 'popular') ? 'selected' : '' %>>Phổ biến nhất</option>
                            <option value="rated" <%= (filters && filters.sort === 'rated') ? 'selected' : '' %>>Đánh giá cao</option>
                            <option value="oldest" <%= (filters && filters.sort === 'oldest') ? 'selected' : '' %>>Cũ nhất</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Áp dụng</button>
                </form>
            </aside>
        </div>

        <!-- Cột Phải: Danh sách tài liệu -->
        <div class="col-lg-9">
            <% if (typeof documents !== 'undefined' && documents.length > 0) { %>
                <%# --- PHẦN NÀY DÀNH CHO DỮ LIỆU THẬT TỪ DATABASE --- %>
                <div class="document-list-header">
                    <p>Hiển thị <strong><%= documents.length %></strong> trong tổng số <strong><%= totalDocuments %></strong> kết quả</p>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    <% documents.forEach(doc => { %>
                        <div class="col">
                            <div class="card h-100 document-card d-flex flex-column">
                                <a href="/learning-hub/document/<%= doc._id %>" class="card-img-top-link">
                                    <div class="card-img-top-placeholder">
                                        <i class="fas fa-file-alt fa-3x"></i>
                                        <% if (doc.fileInfo && doc.fileInfo.originalName) { %>
                                            <span class="file-type-badge"><%= doc.fileInfo.originalName.split('.').pop().toUpperCase() %></span>
                                        <% } %>
                                    </div>
                                </a>
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">
                                        <a href="/learning-hub/document/<%= doc._id %>"><%= doc.title %></a>
                                    </h5>
                                    <p class="card-text text-muted small"><%= doc.description.substring(0, 70) %>...</p>
                                    <div class="mt-auto pt-3">
                                        <small class="text-muted d-block">bởi <strong><%= doc.uploader.username %></strong></small>
                                        <small class="text-muted d-block">ngày <%= new Date(doc.createdAt).toLocaleDateString('vi-VN') %></small>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between align-items-center">
                                         <small class="text-muted"><i class="fas fa-star text-warning"></i> <%= doc.averageRating.toFixed(1) %></small>
                                         <small class="text-muted"><i class="fas fa-download"></i> <%= doc.downloads %></small>
                                         <small class="text-muted"><i class="fas fa-eye"></i> <%= doc.views %></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>

                <!-- Phân trang cho dữ liệu thật -->
                <% if (totalPages > 1) { %>
                    <%- include('../../partials/pagination', { currentPage: currentPage, totalPages: totalPages, baseUrl: `/learning-hub?sort=${filters.sort}&category=${filters.category}&subject=${filters.subject}&q=${filters.q || ''}` }) %>
                <% } %>
            <% } else { %>
                <%# --- PHẦN BÀI ĐĂNG MẪU KHI DATABASE TRỐNG --- %>
                <%
                    const allSampleDocuments = [
                        { _id: 'sample1', title: 'Giáo trình Nhập môn Quan hệ Công chúng', description: 'Tài liệu cơ bản cho sinh viên ngành PR.', category: 'ebook', subject: 'Quan-hệ-công-chúng', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 152, views: 830, uploader: { username: 'thanhmai' }, createdAt: '2025-10-18T10:00:00Z', externalUrl: 'https://www.scribd.com/document/514168824/Giao-Trinh-Quan-H%E1%BB%87-Cong-Chung-894525' },
                        { _id: 'sample2', title: 'Đề cương ôn tập Triết học Mác-Lênin', description: 'Tổng hợp câu hỏi và đáp án chi tiết.', category: 'exam', subject: 'Triết-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 210, views: 1200, uploader: { username: 'minhquan' }, createdAt: '2025-10-17T11:30:00Z', externalUrl: 'https://www.scribd.com/document/800409487/%C4%90%E1%BB%81-C%C6%B0%C6%A1ng-On-T%E1%BA%ADp-Tri%E1%BA%BFt-H%E1%BB%8Dc-Mac-Lenin' },
                        { _id: 'sample3', title: 'Slide bài giảng Tâm lý học Giao tiếp', description: 'Bài giảng của TS. Huỳnh Văn Sơn.', category: 'lecture', subject: 'Tâm-lý-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.5, downloads: 95, views: 640, uploader: { username: 'hoangan' }, createdAt: '2025-10-16T14:00:00Z', externalUrl: 'https://www.scribd.com/document/895586392/Tam-L%C3%BD-H%E1%BB%8Dc-Giao-Ti%E1%BA%BFp-Slide-Bai-Gi%E1%BA%A3ng' },
                        { _id: 'sample4', title: 'Giáo trình Lịch sử Quan hệ quốc tế', description: 'Tài liệu chuẩn của khoa Quốc tế học.', category: 'ebook', subject: 'Quốc-tế-học', fileInfo: { fileType: 'DOCX' }, averageRating: 4.7, downloads: 180, views: 950, uploader: { username: 'bichphuong' }, createdAt: '2025-10-15T09:00:00Z', externalUrl: 'https://www.scribd.com/document/742390136/L%E1%BB%8Bch-s%E1%BB%AD-quan-h%E1%BB%87-qu%E1%BB%91c-t%E1%BA%BF-V%C5%A9-D%C6%B0%C6%A1ng-Ninh' },
                        { _id: 'sample5', title: 'Bài giảng Phân loại tài liệu thư viện', description: 'Slide chi tiết về các chuẩn phân loại.', category: 'lecture', subject: 'Thông-tin-Thư-viện', fileInfo: { fileType: 'PDF' }, averageRating: 4.6, downloads: 130, views: 780, uploader: { username: 'giabao' }, createdAt: '2025-10-14T16:20:00Z', externalUrl: 'https://www.scribd.com/document/873166998/2-Giao-Trinh-Phan-Lo%E1%BA%A1i-Tai-Li%E1%BB%87u' },
                        { _id: 'sample6', title: 'Tổng hợp đề thi môn Xã hội học đại cương', description: 'Bao gồm cả tự luận và trắc nghiệm qua các năm.', category: 'exam', subject: 'Xã-hội-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 88, views: 520, uploader: { username: 'thuychi' }, createdAt: '2025-10-13T08:00:00Z', externalUrl: 'https://www.scribd.com/document/721714466/B%E1%BB%99-cau-h%E1%BB%8Fi-tr%E1%BA%AFc-nghi%E1%BB%87m-mon-Xa-h%E1%BB%99i-h%E1%BB%8Dc-%C4%91%E1%BA%A1i-c%C6%B0%C6%A1ng-co-%C4%91ap-an' },
                        { _id: 'sample7', title: 'Giáo trình Cơ sở văn hóa phương Đông', description: 'Tài liệu dành cho ngành Đông phương học.', category: 'ebook', subject: 'Đông-phương-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.9, downloads: 115, views: 880, uploader: { username: 'namphong' }, createdAt: '2025-10-12T13:45:00Z', externalUrl: 'https://www.scribd.com/document/805661147/GIA-O-TRI-NH-VA-N-HO-A-PHU-O-NG-%C4%90O-NG' },
                        { _id: 'sample8', title: 'Kỹ năng viết cho Báo chí hiện đại', description: 'Tài liệu hướng dẫn các thể loại báo chí mới.', category: 'other', subject: 'Báo-chí', fileInfo: { fileType: 'DOCX' }, averageRating: 4.7, downloads: 75, views: 450, uploader: { username: 'hongnhung' }, createdAt: '2025-10-11T19:00:00Z', externalUrl: 'https://www.scribd.com/document/685377990/Tin-va-k%E1%BB%B9-n%C4%83ng-vi%E1%BA%BFt-Tin-bao-chi-hi%E1%BB%87n-%C4%91%E1%BA%A1i' },
                        { _id: 'sample9', title: 'Đề thi cuối kỳ môn Xã hội học Gia đình', description: 'Đề thi của học kỳ 1 năm học 2024-2025.', category: 'exam', subject: 'Xã-hội-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.4, downloads: 60, views: 390, uploader: { username: 'quanghuy' }, createdAt: '2025-10-10T10:10:00Z', externalUrl: 'https://www.scribd.com/document/871611051/%C4%91e-cu-o-ng-cuo-i-mo-n-xa-ho-i-ho-c-gia-%C4%91i-nh' },
                        { _id: 'sample10', title: 'Nhập môn Hàn Quốc học', description: 'Tổng quan về Lịch sử, văn hóa và kinh tế Hàn Quốc.', category: 'lecture', subject: 'Hàn-Quốc-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 92, views: 610, uploader: { username: 'admin' }, createdAt: '2025-10-09T22:00:00Z', externalUrl: 'https://www.scribd.com/document/851933581/Nh%E1%BA%ADp-mon-Han-Qu%E1%BB%91c-h%E1%BB%8Dc' },
                        { _id: 'sample11', title: 'Tổng hợp đề thi Chính sách đối ngoại Việt Nam', description: 'Các đề thi cuối kỳ và giữa kỳ qua các năm.', category: 'exam', subject: 'Quốc-tế-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.6, downloads: 140, views: 750, uploader: { username: 'anhtuan' }, createdAt: '2025-10-08T14:30:00Z', externalUrl: 'https://www.scribd.com/document/808257311/Cau-H%E1%BB%8Fi-Tr%E1%BA%AFc-Nghi%E1%BB%87m-Chinh-Sach-%C4%90%E1%BB%91i-Ngo%E1%BA%A1i-Vi%E1%BB%87t-Nam-T%E1%BB%AB-1975-%C4%90%E1%BA%BFn-Nay-2' },
                        { _id: 'sample12', title: 'Giáo trình Tâm lý học phát triển', description: 'Nghiên cứu sự phát triển tâm lý con người.', category: 'ebook', subject: 'Tâm-lý-học', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 190, views: 1100, uploader: { username: 'ngoclan' }, createdAt: '2025-10-07T11:00:00Z', externalUrl: 'https://www.scribd.com/document/525769405/Giao-Trinh-Tam-L%C3%BD-H%E1%BB%8Dc-Phat-Tri%E1%BB%83n-Tr%C6%B0%C6%A1ng-Th%E1%BB%8B-Khanh-Ha' },
                        { _id: 'sample13', title: 'Bài giảng Các lý thuyết Xã hội học', description: 'Slide bài giảng về các nhà lý thuyết kinh điển.', category: 'lecture', subject: 'Xã-hội-học', fileInfo: { fileType: 'PPTX' }, averageRating: 4.7, downloads: 105, views: 680, uploader: { username: 'trunghieu' }, createdAt: '2025-10-06T17:00:00Z', externalUrl: 'https://www.scribd.com/document/901128820/Bai-Gi%E1%BA%A3ng-Xa-H%E1%BB%99i-H%E1%BB%8Dc-%C4%90%E1%BA%A1i-C%C6%B0%C6%A1ng' },
                        { _id: 'sample14', title: 'Cẩm nang đạo đức nghề nghiệp nhà báo', description: 'Quy tắc và chuẩn mực đạo đức trong báo chí.', category: 'other', subject: 'Báo-chí', fileInfo: { fileType: 'PDF' }, averageRating: 4.9, downloads: 85, views: 550, uploader: { username: 'thaophuong' }, createdAt: '2025-10-05T09:45:00Z', externalUrl: 'http://vci.vnu.edu.vn/upload/15022/pdf/576367957f8b9a1ec78b45d2.pdf' },
                        { _id: 'sample15', title: 'Kỹ năng quản lý thời gian hiệu quả', description: 'Sách hướng dẫn các phương pháp quản lý thời gian.', category: 'ebook', subject: 'Ngành-khác', fileInfo: { fileType: 'PDF' }, averageRating: 4.8, downloads: 250, views: 1500, uploader: { username: 'admin' }, createdAt: '2025-10-04T20:00:00Z', externalUrl: 'https://www.pace.edu.vn/tin-kho-tri-thuc/quan-ly-thoi-gian' }
                    ];

                    let filteredDocuments = allSampleDocuments;
                    
                    const currentPage = (typeof page !== 'undefined') ? parseInt(page) : 1;

                    // Lọc và Sắp xếp
                    if (filters && filters.category && filters.category !== 'all') { filteredDocuments = filteredDocuments.filter(doc => doc.category === filters.category); }
                    if (filters && filters.subject && filters.subject !== 'all') { filteredDocuments = filteredDocuments.filter(doc => doc.subject === filters.subject); }
                    if (filters && filters.q) {
                        const query = filters.q.toLowerCase();
                        filteredDocuments = filteredDocuments.filter(doc => doc.title.toLowerCase().includes(query) || doc.description.toLowerCase().includes(query));
                    }
                    const sortType = (filters && filters.sort) ? filters.sort : 'newest';
                    if (sortType === 'popular' || sortType === 'rated') { filteredDocuments.sort((a, b) => b.views - a.views); } 
                    else if (sortType === 'oldest') { filteredDocuments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); } 
                    else { filteredDocuments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); }

                    // Phân trang
                    const docsPerPage = 10;
                    const totalSampleDocs = filteredDocuments.length;
                    const totalSamplePages = Math.ceil(totalSampleDocs / docsPerPage);
                    const paginatedDocs = filteredDocuments.slice((currentPage - 1) * docsPerPage, currentPage * docsPerPage);
                %>
                
                <% if (paginatedDocs.length > 0) { %>
                    <div class="document-list-header">
                        <p>Hiển thị <strong><%= paginatedDocs.length %></strong> trên tổng số <strong><%= totalSampleDocs %></strong> tài liệu mẫu</p>
                    </div>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                        <% paginatedDocs.forEach(doc => { %>
                            <div class="col">
                                <div class="card h-100 document-card d-flex flex-column">
                                    <a href="<%= doc.externalUrl %>" class="card-img-top-link" target="_blank">
                                        <div class="card-img-top-placeholder">
                                            <i class="fas fa-file-alt fa-3x"></i>
                                            <span class="file-type-badge"><%= doc.fileInfo.fileType.toUpperCase() %></span>
                                        </div>
                                    </a>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">
                                            <a href="<%= doc.externalUrl %>" target="_blank"><%= doc.title %></a>
                                        </h5>
                                        <p class="card-text text-muted small"><%= doc.description.substring(0, 70) %>...</p>
                                        <div class="mt-auto pt-3">
                                            <small class="text-muted d-block">bởi <strong><%= doc.uploader.username %></strong></small>
                                            <small class="text-muted d-block">ngày <%= new Date(doc.createdAt).toLocaleDateString('vi-VN') %></small>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-flex justify-content-between align-items-center">
                                             <small class="text-muted"><i class="fas fa-star text-warning"></i> <%= doc.averageRating.toFixed(1) %></small>
                                             <small class="text-muted"><i class="fas fa-download"></i> <%= doc.downloads %></small>
                                             <small class="text-muted"><i class="fas fa-eye"></i> <%= doc.views %></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <% if (totalSamplePages > 1) { %>
                        <%- include('../../partials/pagination', { 
                            currentPage: currentPage, 
                            totalPages: totalSamplePages, 
                            baseUrl: `/learning-hub?sort=${(filters && filters.sort) || 'newest'}&category=${(filters && filters.category) || 'all'}&subject=${(filters && filters.subject) || 'all'}&q=${(filters && filters.q) || ''}&page=` 
                        }) %>
                    <% } %>

                <% } else { %>
                    <div class="alert alert-info text-center mt-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <h4>Không tìm thấy tài liệu nào.</h4>
                        <p>Không có tài liệu mẫu nào khớp với bộ lọc của bạn.</p>
                    </div>
                <% } %>
            <% } %>
        </div>
    </div>
</div>

<style>
  #learning-hub-upload-link {
    position: relative;
    z-index: 99; /* Đảm bảo nút này nằm trên các yếu tố khác */
    pointer-events: auto !important; /* Buộc nút này phải nhận tín hiệu nhấp chuột */
  }
</style>
