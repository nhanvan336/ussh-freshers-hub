<div class="container my-5">
  <a href="/wellness" class="back-link mb-4 d-inline-block"><i class="fas fa-arrow-left"></i> Quay lại Góc sức khỏe</a>
  
  <div class="text-center mb-5">
    <h1><i class="fas fa-question-circle text-primary"></i> Hỏi đáp ẩn danh</h1>
    <p class="lead text-muted">Mọi câu hỏi đều đáng được lắng nghe. Mọi thông tin bạn chia sẻ đều được bảo mật.</p>
  </div>
  
  <div class="card p-4 mb-5 mx-auto shadow-sm" style="max-width: 800px;">
    <h5 class="card-title mb-3">Gửi câu hỏi mới</h5>
    <form action="/wellness/ask" method="POST">
      <div class="mb-3">
        <textarea id="auto-resize-textarea" class="form-control" name="questionContent" rows="3" placeholder="Bạn có điều gì băn khoăn? Hãy chia sẻ ở đây..." required style="font-size: 1.1rem;"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-paper-plane me-2"></i>Gửi câu hỏi ẩn danh
      </button>
    </form>
  </div>

  <div class="discussion-list mx-auto" style="max-width: 800px;">
    <h3 class="mb-4 text-center">Cùng nhau thảo luận</h3>
    
    <% if (questions && questions.length > 0) { %>
      <% questions.forEach(question => { %>
        <div class="card mb-4 bg-light">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-user-secret fa-2x text-muted me-3"></i>
              <div>
                <strong>Người hỏi ẩn danh #<%= question.anonymousId %></strong>
                <div class="text-muted small">
                  <%= new Date(question.createdAt).toLocaleString('vi-VN') %>
                </div>
              </div>
            </div>
            <p class="card-text fs-5 ps-1"><%= question.content %></p>
            
            <div class="d-flex align-items-center mt-3 text-muted small">
              <form action="/wellness/ask/<%= question.id %>/like" method="POST" class="me-3">
                <button type="submit" class="btn btn-link text-muted text-decoration-none p-0">
                  <i class="fas fa-thumbs-up me-1"></i> Thích (<%= question.likes.length %>)
                </button>
              </form>
              <form action="/wellness/ask/<%= question.id %>/dislike" method="POST" class="me-3">
                <button type="submit" class="btn btn-link text-muted text-decoration-none p-0">
                  <i class="fas fa-thumbs-down me-1"></i> Không thích (<%= question.dislikes.length %>)
                </button>
              </form>
              <a href="#reply-form-<%= question.id %>" class="text-muted text-decoration-none">
                <i class="fas fa-reply me-1"></i> Trả lời
              </a>
            </div>
            </div>

          <div class="mx-3 mb-3 bg-white p-3 rounded">
            <% if (question.replies && question.replies.length > 0) { %>
              <h6 class="mb-3">Các câu trả lời:</h6>
              <% question.replies.forEach(reply => { %>
                <div class="d-flex mt-3">
                  <div class="flex-shrink-0">
                    <img src="<%= reply.user.avatar || '/images/default-avatar.png' %>" alt="avatar" class="rounded-circle" width="40" height="40">
                  </div>
                  <div class="ms-3 flex-grow-1">
                    <div>
                      <strong><%= reply.user.fullName %></strong>
                      <p class="mb-0 small"><%= reply.content %></p>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <p class="text-muted small ps-1 mb-0">Chưa có câu trả lời nào.</p>
            <% } %>

            <hr class="my-3">
            <% if (user) { %>
              <form id="reply-form-<%= question.id %>" action="/wellness/ask/<%= question.id %>/reply" method="POST" class="d-flex">
                <input type="text" class="form-control me-2" name="replyContent" placeholder="Viết câu trả lời của bạn..." required>
                <button type="submit" class="btn btn-outline-primary btn-sm">Gửi</button>
              </form>
            <% } else { %>
              <p class="text-muted mb-0 small text-center">
                <a href="/login">Đăng nhập</a> để tham gia thảo luận.
              </p>
            <% } %>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <p class="text-center text-muted">Chưa có câu hỏi nào được gửi. Hãy là người đầu tiên đặt câu hỏi!</p>
    <% } %>

    <% if (totalPages > 1) { %>
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="/wellness/ask?page=<%= currentPage - 1 %>">Trước</a>
          </li>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
              <a class="page-link" href="/wellness/ask?page=<%= i %>"><%= i %></a>
            </li>
          <% } %>
          <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="/wellness/ask?page=<%= currentPage + 1 %>">Sau</a>
          </li>
        </ul>
      </nav>
    <% } %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    const textarea = document.getElementById('auto-resize-textarea');
    if (textarea) {
      const autoResize = () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      };
      textarea.addEventListener('input', autoResize);
      autoResize();
    }
  });
</script>
